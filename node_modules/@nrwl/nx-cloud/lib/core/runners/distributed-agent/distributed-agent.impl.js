const a5_0x58fd=['We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','completedStatusCode','random','../../../utilities/nx-imports','warn','__awaiter','Distributed\x20Execution\x20Terminated','inherit','.lock','Agent\x20','target','--configuration=','note','error','printRunGroupError','../../../utilities/metric-logger','assign','__esModule','projects','unlinkSync','retryDuring','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','catch','readFileSync','default','parse','apply','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','cacheDirectory','maxParallel','SIGINT','join','env','existsSync','Error:','Critical\x20Error\x20in\x20Agent:\x20\x22','then','Waiter','getTime','taskId','reset','completed:\x20','push','options','execSync','../../error/print-run-group-error','maxParallel:\x20','mkdirSync','CIRCLE_STAGE','error:\x20','/nx.json','completed','tasks','completeRunGroupWithError','VERBOSE_LOGGING','message','child_process','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','includes','/tasks-hashes-','toString','/lockfiles','throw','configuration','number\x20of\x20tasks:\x20','executionId','API\x20Response','./node_modules/.cache/nx','CIRCLECI','map','Executing:\x20\x27','submitRunMetrics','readdirSync','getRunGroup','Waiting...','forEach','wait','DistributedAgentApi','exit','CIRCLE_JOB','value','retryDuring:\x20','params','NX_AGENT_NAME','createNoNewMessagesTimeout','next','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','writeFileSync','done','Fetching\x20tasks...','find','../../../utilities/environment','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','true','Duplicate\x20Agent\x20ID\x20Detected'];(function(_0xb83545,_0x58fdd5){const _0x538276=function(_0x938392){while(--_0x938392){_0xb83545['push'](_0xb83545['shift']());}};_0x538276(++_0x58fdd5);}(a5_0x58fd,0x94));const a5_0x5382=function(_0xb83545,_0x58fdd5){_0xb83545=_0xb83545-0x0;let _0x538276=a5_0x58fd[_0xb83545];return _0x538276;};'use strict';var __awaiter=this&&this[a5_0x5382('0x31')]||function(_0x353f47,_0xd84879,_0x149b4e,_0x44e0d9){function _0x443111(_0x3f0731){return _0x3f0731 instanceof _0x149b4e?_0x3f0731:new _0x149b4e(function(_0x37ad9b){_0x37ad9b(_0x3f0731);});}return new(_0x149b4e||(_0x149b4e=Promise))(function(_0x43034d,_0xac4f89){function _0x17d00b(_0x5c2562){try{_0x3c7e5e(_0x44e0d9[a5_0x5382('0x21')](_0x5c2562));}catch(_0x52b5ac){_0xac4f89(_0x52b5ac);}}function _0x59a149(_0x278714){try{_0x3c7e5e(_0x44e0d9[a5_0x5382('0xa')](_0x278714));}catch(_0xd731aa){_0xac4f89(_0xd731aa);}}function _0x3c7e5e(_0x483c35){_0x483c35[a5_0x5382('0x24')]?_0x43034d(_0x483c35[a5_0x5382('0x1c')]):_0x443111(_0x483c35[a5_0x5382('0x1c')])[a5_0x5382('0x50')](_0x17d00b,_0x59a149);}_0x3c7e5e((_0x44e0d9=_0x44e0d9[a5_0x5382('0x46')](_0x353f47,_0xd84879||[]))[a5_0x5382('0x21')]());});};Object['defineProperty'](exports,a5_0x5382('0x3d'),{'value':!![]});exports['startAgent']=void 0x0;const child_process_1=require(a5_0x5382('0x4'));const stripJsonComments=require('strip-json-comments');const distributed_agent_api_1=require('./distributed-agent.api');const waiter_1=require('../../../utilities/waiter');const environment_1=require(a5_0x5382('0x27'));const print_run_group_error_1=require(a5_0x5382('0x59'));const create_no_new_messages_timeout_1=require('../../../utilities/create-no-new-messages-timeout');const fs_1=require('fs');const metric_logger_1=require(a5_0x5382('0x3b'));const {output,workspaceRoot}=require(a5_0x5382('0x2f'));function executeTasks(_0x35983b,_0x1fcf17){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x4a687c=0x0;let _0x477114=null;const _0x3150cc=(0x0,create_no_new_messages_timeout_1[a5_0x5382('0x20')])();const _0x4b49e0=new waiter_1[(a5_0x5382('0x51'))]();let _0x62b63f=[];const _0x5b9cb3=new Date();let _0x103b28=![];while(!![]){if(environment_1[a5_0x5382('0x2')]){output['note']({'title':a5_0x5382('0x25')});}_0x477114=yield _0x1fcf17[a5_0x5382('0x0')](_0x477114?_0x477114[a5_0x5382('0xd')]:null,_0x4a687c,_0x62b63f);if(environment_1[a5_0x5382('0x2')]){output['note']({'title':a5_0x5382('0xe'),'bodyLines':[a5_0x5382('0x55')+_0x477114[a5_0x5382('0x5f')],a5_0x5382('0x1d')+_0x477114[a5_0x5382('0x40')],'executionId:\x20'+_0x477114[a5_0x5382('0xd')],a5_0x5382('0xc')+_0x477114[a5_0x5382('0x0')]['length'],a5_0x5382('0x5d')+_0x477114['criticalErrorMessage'],a5_0x5382('0x5a')+_0x477114[a5_0x5382('0x49')]]});}if(_0x477114['criticalErrorMessage']){output['error']({'title':a5_0x5382('0x32'),'bodyLines':[a5_0x5382('0x4e'),_0x477114['criticalErrorMessage']]});process[a5_0x5382('0x1a')](0x0);}if((_0x477114===null||_0x477114===void 0x0?void 0x0:_0x477114[a5_0x5382('0x40')])&&(_0x477114===null||_0x477114===void 0x0?void 0x0:_0x477114[a5_0x5382('0x40')])!==0x0&&!_0x103b28&&new Date()[a5_0x5382('0x52')]()-_0x5b9cb3[a5_0x5382('0x52')]()>_0x477114['retryDuring']){yield _0x4b49e0[a5_0x5382('0x18')]();continue;}if(_0x477114[a5_0x5382('0x5f')])return;_0x3150cc(_0x477114[a5_0x5382('0x0')][a5_0x5382('0x11')](_0x5e61b7=>_0x5e61b7[a5_0x5382('0x53')])['join'](''));if(!_0x477114[a5_0x5382('0xd')]){if(environment_1[a5_0x5382('0x2')]){output[a5_0x5382('0x38')]({'title':a5_0x5382('0x16')});}yield _0x4b49e0[a5_0x5382('0x18')]();_0x4a687c=0x0;_0x62b63f=[];continue;}_0x4b49e0[a5_0x5382('0x54')]();_0x103b28=!![];const _0x5ce953=invokeTasksUsingRunMany(_0x35983b,_0x477114['executionId'],_0x477114['tasks'],_0x477114[a5_0x5382('0x49')]);_0x4a687c=_0x5ce953[a5_0x5382('0x2d')];_0x62b63f=_0x5ce953['completedTasks'];}});}function readCompletedTasks(_0x3cdd36,_0x25c607){const _0x411554=a5_0x5382('0x28')+_0x25c607+').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.';let _0x48b63b;try{const _0x316071=_0x3cdd36['cacheDirectory']||a5_0x5382('0xf');const _0x46baa3=_0x316071+a5_0x5382('0x7')+_0x25c607;_0x48b63b=JSON[a5_0x5382('0x45')]((0x0,fs_1[a5_0x5382('0x43')])(_0x46baa3)[a5_0x5382('0x8')]());(0x0,fs_1['unlinkSync'])(_0x46baa3);}catch(_0x5e6168){throw new Error(_0x411554);}if(_0x48b63b['length']==0x0){throw new Error(_0x411554);}return _0x48b63b;}function invokeTasksUsingRunMany(_0x1b8372,_0x1be021,_0x1080c5,_0x44b906){let _0x1a1877=0x0;const _0x2c4116=[];for(const _0x2941b9 of groupByTarget(_0x1080c5)){const _0x299bcb=_0x2941b9[a5_0x5382('0xb')]?a5_0x5382('0x37')+_0x2941b9[a5_0x5382('0xb')]:'';const _0x33ce7e=_0x44b906>0x1?'\x20--parallel\x20--max-parallel='+_0x44b906:'';const _0x2c6e31='npx\x20nx\x20run-many\x20--target='+_0x2941b9[a5_0x5382('0x36')]+'\x20'+_0x299bcb+'\x20--projects='+_0x2941b9[a5_0x5382('0x3e')][a5_0x5382('0x4b')](',')+'\x20'+_0x2941b9['params']+_0x33ce7e;if(environment_1[a5_0x5382('0x2')]){output[a5_0x5382('0x38')]({'title':a5_0x5382('0x12')+_0x2c6e31+'\x27'});}try{(0x0,child_process_1[a5_0x5382('0x58')])(_0x2c6e31,{'stdio':[a5_0x5382('0x33'),a5_0x5382('0x33'),a5_0x5382('0x33')],'env':Object[a5_0x5382('0x3c')](Object[a5_0x5382('0x3c')]({},process[a5_0x5382('0x4c')]),{'NX_CACHE_FAILURES':a5_0x5382('0x2a'),'NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x1be021})});}catch(_0xd73f2){if(_0xd73f2['status']===environment_1[a5_0x5382('0x29')]){throw _0xd73f2;}else{_0x1a1877=0x1;}}finally{_0x2c4116[a5_0x5382('0x56')](...readCompletedTasks(_0x1b8372,_0x1be021));}}return{'completedStatusCode':_0x1a1877,'completedTasks':_0x2c4116};}function groupByTarget(_0x361e57){const _0x2f8233=[];_0x361e57[a5_0x5382('0x17')](_0x321eeb=>{const _0x75fae2=_0x2f8233[a5_0x5382('0x26')](_0x496687=>_0x496687[a5_0x5382('0x36')]===_0x321eeb[a5_0x5382('0x36')]&&_0x496687[a5_0x5382('0xb')]===_0x321eeb['configuration']);if(_0x75fae2){_0x75fae2[a5_0x5382('0x3e')][a5_0x5382('0x56')](_0x321eeb['projectName']);}else{_0x2f8233['push']({'target':_0x321eeb[a5_0x5382('0x36')],'projects':[_0x321eeb['projectName']],'params':_0x321eeb[a5_0x5382('0x1e')],'configuration':_0x321eeb[a5_0x5382('0xb')]});}});return _0x2f8233;}function getAgentName(){if(process[a5_0x5382('0x4c')][a5_0x5382('0x1f')]!==undefined){return process[a5_0x5382('0x4c')]['NX_AGENT_NAME'];}else if(process['env'][a5_0x5382('0x10')]!==undefined&&process['env'][a5_0x5382('0x5c')]){return process['env']['CIRCLE_STAGE'];}else if(process[a5_0x5382('0x4c')][a5_0x5382('0x10')]!==undefined&&process[a5_0x5382('0x4c')][a5_0x5382('0x1b')]){return process[a5_0x5382('0x4c')][a5_0x5382('0x1b')];}else{return a5_0x5382('0x35')+Math['floor'](Math[a5_0x5382('0x2e')]()*0x186a0);}}function createAgentLockfile(_0x400541,_0x40dce0){const _0xf6cb3d=_0x400541[a5_0x5382('0x48')]||a5_0x5382('0xf');const _0x57226b=_0xf6cb3d+a5_0x5382('0x9');const _0x1b0628=_0x57226b+'/'+_0x40dce0+a5_0x5382('0x34');if(!(0x0,fs_1[a5_0x5382('0x4d')])(_0x57226b)){(0x0,fs_1[a5_0x5382('0x5b')])(_0x57226b,{'recursive':!![]});}const _0x541ef3=(0x0,fs_1[a5_0x5382('0x14')])(_0x57226b);if(_0x541ef3['length']){if(_0x541ef3[a5_0x5382('0x6')](_0x40dce0+'.lock')){output[a5_0x5382('0x39')]({'title':a5_0x5382('0x2b'),'bodyLines':[a5_0x5382('0x41'),'','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.']});process[a5_0x5382('0x1a')](0x1);}output[a5_0x5382('0x30')]({'title':'Other\x20Nx\x20Cloud\x20Agents\x20Detected','bodyLines':[a5_0x5382('0x2c'),'',a5_0x5382('0x47'),a5_0x5382('0x22')]});}(0x0,fs_1[a5_0x5382('0x23')])(_0x1b0628,'');process['on'](a5_0x5382('0x1a'),_0x4c58fa=>cleanupAgentLockfile(_0x1b0628,_0x4c58fa));process['on'](a5_0x5382('0x4a'),()=>cleanupAgentLockfile(_0x1b0628,0x0));}function cleanupAgentLockfile(_0x5d7da9,_0x1347cb){if((0x0,fs_1[a5_0x5382('0x4d')])(_0x5d7da9)){(0x0,fs_1[a5_0x5382('0x3f')])(_0x5d7da9);process[a5_0x5382('0x1a')](_0x1347cb);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x4845ef=(0x0,environment_1[a5_0x5382('0x15')])();if(!_0x4845ef){(0x0,print_run_group_error_1[a5_0x5382('0x3a')])();return process[a5_0x5382('0x1a')](0x1);}output['note']({'title':a5_0x5382('0x5')});const _0x1a4a38=JSON['parse'](stripJsonComments((0x0,fs_1['readFileSync'])(workspaceRoot+a5_0x5382('0x5e'))[a5_0x5382('0x8')]()))['tasksRunnerOptions'][a5_0x5382('0x44')][a5_0x5382('0x57')];const _0x23e50c=getAgentName();createAgentLockfile(_0x1a4a38,_0x23e50c);const _0x584316=new distributed_agent_api_1[(a5_0x5382('0x19'))](_0x1a4a38,_0x4845ef,_0x23e50c);return executeTasks(_0x1a4a38,_0x584316)[a5_0x5382('0x50')](_0xa67e93=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a5_0x5382('0x13')])(_0x1a4a38);return _0xa67e93;}))[a5_0x5382('0x42')](_0x4a0446=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x584316[a5_0x5382('0x1')](a5_0x5382('0x4f')+_0x4a0446[a5_0x5382('0x3')]+'\x22');throw _0x4a0446;}));});}exports['startAgent']=startAgent;